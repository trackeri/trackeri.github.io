<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Uređaji</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --main-bg: #f4f6fb;
            --card-bg: #fff;
            --primary: #1976d2;
            --success: #43a047;
            --danger: #e53935;
            --warning: #fbc02d;
            --muted: #bdbdbd;
            --border: #e0e0e0;
            --text: #222;
            --radius: 1rem;
            --shadow: 0 2px 8px rgba(0,0,0,0.07);
        }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif; /* Promijenjen font */
            background: var(--main-bg);
            color: var(--text);
        }

        header {
            background: var(--primary);
            color: #fff;
            padding: 1rem 2rem;
            font-size: 2rem;
            letter-spacing: 2px;
            font-weight: 600;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            border-bottom-left-radius: var(--radius); /* Dodani zaobljeni rubovi */
            border-bottom-right-radius: var(--radius);
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 0.7em;
        }

        .header-actions {
            display: flex;
            gap: 1rem; /* Razmak između gumba */
            align-items: center;
        }

        .settings-btn, .refresh-btn { /* Dodan .refresh-btn */
            display: flex;
            align-items: center;
            gap: 0.3em;
            font-size: 1.05rem;
            cursor: pointer;
            background: rgba(255,255,255,0.07);
            border-radius: .7em;
            padding: .18em .6em;
            transition: background 0.2s, color 0.2s;
        }

            .settings-btn:hover, .refresh-btn:hover { /* Dodan .refresh-btn */
                background: rgba(255,255,255,0.18);
                color: var(--warning);
            }

            .settings-btn i, .refresh-btn i { /* Dodan .refresh-btn */
                font-size: 1.1em;
            }

        .settings-label {
            font-size: 1em;
            font-weight: 500;
            letter-spacing: 0.5px;
            margin-left: 0.2em;
        }

        /* Status Icon Styles */
        .status-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px; /* Adjust size as needed */
            height: 24px;
            border-radius: 50%;
            font-size: 1em;
            color: #fff;
            margin-left: 0.5rem; /* Space from refresh button */
            transition: background-color 0.3s ease-in-out;
        }

            .status-icon i {
                font-size: 1em;
            }

        .status-loading {
            background-color: var(--warning);
        }

            .status-loading i {
                animation: spin 1s linear infinite;
            }

        .status-success {
            background-color: var(--success);
        }

        .status-error {
            background-color: var(--danger);
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }


        .main-content {
            display: flex;
            gap: 2rem;
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
            min-height: 70vh;
        }

        .devices-panel {
            flex: 1 1 350px;
            min-width: 320px;
            max-width: 420px;
            display: flex;
            flex-direction: column;
        }

        .devices {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }

        .device-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 1.2rem 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            border: 1px solid var(--border);
            position: relative;
            transition: box-shadow .2s, border-color .2s;
            cursor: pointer;
        }

            .device-card.selected {
                border: 2px solid var(--primary);
                box-shadow: 0 4px 16px rgba(25, 118, 210, 0.13);
                background: #e3f0ff;
            }

        .device-header {
            display: flex;
            align-items: center;
            gap: .7rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
        }

        .device-props {
            display: flex;
            flex-wrap: wrap;
            gap: .5rem 1.1rem;
            font-size: 1.01rem;
            align-items: center;
        }

        .prop {
            display: flex;
            align-items: center;
            gap: .3rem;
            min-width: 90px;
        }

            .prop i {
                font-size: 1.05em;
            }

        .battery-bar {
            width: 36px;
            height: 10px;
            border-radius: 4px;
            background: var(--border);
            margin-left: 4px;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
            position: relative;
        }

        .battery-bar-inner {
            height: 100%;
            border-radius: 4px;
            transition: width .3s;
        }

        .distance {
            font-size: .98em;
            color: var(--muted);
            margin-left: 2px;
        }

        .last-update {
            font-size: .93em;
            color: var(--muted);
            margin-top: .5rem;
            display: flex;
            align-items: center;
            gap: .4rem;
        }

        .map-panel {
            flex: 2 1 500px;
            min-width: 320px;
            display: flex;
            flex-direction: column;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            background: var(--card-bg);
            border: 1px solid var(--border);
            height: 600px;
            min-height: 400px;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
            min-height: 400px;
        }
        /* Tabs for mobile */
        .tabs {
            display: none;
            margin-bottom: 1rem;
        }

        .tab-btn {
            flex: 1 1 0;
            padding: .7em 0;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-bottom: none;
            font-size: 1.1em;
            color: var(--primary);
            cursor: pointer;
            font-weight: 600;
            transition: background .2s, color .2s;
        }

            .tab-btn.active {
                background: var(--primary);
                color: #fff;
            }

        @media (max-width: 900px) {
            .main-content {
                flex-direction: column;
                gap: 1.2rem;
                min-height: unset;
            }

            .map-panel, .devices-panel {
                min-width: 0;
                max-width: 100vw;
                width: 100%;
                height: 350px;
            }

            .map-panel {
                height: 350px;
            }
        }

        @media (max-width: 600px) {
            header {
                flex-direction: row; /* Promijenjeno za poravnanje na mobilnom */
                align-items: center;
                justify-content: space-between; /* Razmak između elemenata */
                font-size: 1.3rem;
                padding: .7rem 1rem; /* Povećan padding za bolji izgled */
            }

            .header-title {
                font-size: 1.3rem; /* Smanjena veličina naslova za mobilni */
            }

            .header-actions { /* Prilagodba za mobilni */
                gap: 0.5rem; /* Manji razmak između gumba */
            }

            .settings-btn, .refresh-btn { /* Prilagodba za mobilni */
                align-self: auto;
                margin-top: 0;
                font-size: .95em;
                padding: .2em .6em;
            }

            .settings-label {
                font-size: .95em;
            }

            .status-icon {
                width: 20px;
                height: 20px;
                font-size: 0.85em;
                margin-left: 0.3rem;
            }

            .main-content {
                flex-direction: column;
                gap: 0;
                margin: 0;
                padding: 0;
            }

            .tabs {
                display: flex;
                width: 100%;
            }

            .devices-panel, .map-panel {
                max-width: 100vw;
                width: 100%;
                min-width: 0;
                border-radius: 0;
                box-shadow: none;
                border: none;
                height: auto;
            }

            .map-panel {
                min-height: 300px;
                height: 300px;
            }
        }

        .popup-bg {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.25);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .popup {
            background: #fff;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 2rem 2.5rem;
            min-width: 300px;
            max-width: 90vw;
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
            align-items: stretch;
        }

        /* Novi stilovi za filter panel */
        .filter-panel {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            padding: 1.2rem 1rem;
            margin-bottom: 1.2rem;
            display: grid; /* Promijenjeno u grid */
            grid-template-columns: repeat(2, 1fr); /* 2 kolone za desktop */
            grid-auto-rows: minmax(auto, auto); /* Automatska visina redova */
            gap: 1.1rem 2rem; /* Povećan razmak između stupaca */
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 0.4em;
        }

            .filter-item label {
                font-weight: 500;
                white-space: nowrap; /* Spriječava prelamanje teksta labela */
            }

            .filter-item select,
            .filter-item input[type="text"],
            .filter-item input[type="password"] {
                flex-grow: 1; /* Omogućuje popunjavanje dostupnog prostora */
                padding: 0.6em 0.2em 0.6em 0.8em; /* Povećan desni padding za select */
                border: 1px solid var(--border);
                border-radius: 0.5rem; /* Zaobljeni rubovi */
                font-size: 1em;
                box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); /* Blagi unutarnji shadow */
                transition: border-color 0.2s, box-shadow 0.2s;
            }

                .filter-item select:focus,
                .filter-item input[type="text"]:focus,
                .filter-item input[type="password"]:focus {
                    border-color: var(--primary);
                    box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2); /* Plavi glow na fokusu */
                    outline: none;
                }

        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: 0.4em;
        }

            .filter-checkbox input[type="checkbox"] {
                width: 1.2em; /* Povećana veličina checkboxa */
                height: 1.2em;
                border-radius: 0.25em; /* Blago zaobljeni rubovi */
                accent-color: var(--primary); /* Boja ispunjenog checkboxa */
                cursor: pointer;
            }

        /* Stilovi za input kontrole u postavkama */
        .popup input[type="text"],
        .popup input[type="password"] {
            padding: 0.8em 1em;
            border: 1px solid var(--border);
            border-radius: 0.75rem; /* Veći zaobljeni rubovi */
            font-size: 1.1em;
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.07);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

            .popup input[type="text"]:focus,
            .popup input[type="password"]:focus {
                border-color: var(--primary);
                box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.3);
                outline: none;
            }

        .popup button {
            padding: 0.8em 1.5em;
            border-radius: 0.75rem;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
            background: var(--primary);
            color: #fff;
            border: none;
            box-shadow: 0 4px 10px rgba(25, 118, 210, 0.2);
        }

            .popup button:hover {
                background: #1565c0; /* Tamnija nijansa primarne boje */
                box-shadow: 0 6px 15px rgba(25, 118, 210, 0.3);
                transform: translateY(-1px);
            }

            .popup button#cancelSettingsBtn {
                background: #e0e0e0 !important;
                color: #555 !important;
                border: 1px solid #ccc !important;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1) !important;
            }

                .popup button#cancelSettingsBtn:hover {
                    background: #d0d0d0 !important;
                    box-shadow: 0 3px 7px rgba(0,0,0,0.15) !important;
                    transform: translateY(-1px);
                }

        /* Novi stil za detalje na karti */
        .info-window-details {
            font-size: 0.97em;
            min-width: 200px;
            max-width: 270px; /* Može se prilagoditi po potrebi */
        }

            .info-window-details .header {
                font-weight: 600;
                color: var(--primary);
                margin-bottom: 8px;
                display: flex;
                align-items: center;
                gap: 5px;
            }

            .info-window-details .prop-grid {
                display: grid;
                grid-template-columns: auto 1fr; /* Ikona + Labela | Vrijednost */
                gap: 2px 8px; /* Razmak između redova i stupaca */
                margin-bottom: 8px;
            }

                .info-window-details .prop-grid .label-icon {
                    display: flex;
                    align-items: center;
                    gap: 4px;
                    white-space: nowrap;
                }

                .info-window-details .prop-grid .value {
                    font-weight: 500;
                }

            .info-window-details .location-info {
                margin-top: 6px;
                display: flex;
                align-items: center;
                gap: 4px;
            }

                .info-window-details .location-info i {
                    font-size: 1.05em;
                }

                .info-window-details .location-info.red {
                    color: var(--danger);
                    font-weight: 600;
                }

            .info-window-details .last-update-info {
                margin-top: 2px;
                display: flex;
                align-items: center;
                gap: 4px;
            }

                .info-window-details .last-update-info.red {
                    color: var(--danger);
                    font-weight: 600;
                }


        @media (max-width: 900px) {
            .filter-panel {
                margin-bottom: 0.7rem;
            }
        }

        @media (max-width: 600px) {
            .filter-panel {
                border-radius: 0;
                box-shadow: none;
                border: none;
                padding: 1rem 0.5rem;
                grid-template-columns: 1fr; /* 1 kolona za mobilni */
                gap: 1rem; /* Prilagođeni razmak za mobilni */
            }
        }
    </style>
</head>
<body>
    <header>
        <span class="header-title">Uređaji</span>
        <div class="header-actions">
            <span id="refreshBtn" class="refresh-btn" title="Osvježi podatke">
                <i class="fa-solid fa-rotate"></i>
            </span>
            <span id="statusIcon" class="status-icon" style="display:none;">
                <!-- Ikona će biti umetnuta ovdje putem JS-a -->
            </span>
            <span id="settingsBtn" class="settings-btn" title="Postavke">
                <i class="fa-solid fa-gear"></i>
                <span class="settings-label">Postavke</span>
            </span>
        </div>
    </header>
    <div class="tabs" id="tabs">
        <button class="tab-btn active" id="tab-filter">Filter</button>
        <button class="tab-btn" id="tab-lista">Lista</button>
        <button class="tab-btn" id="tab-karta">Karta</button>
    </div>
    <div class="main-content">
        <div class="devices-panel" id="devices-panel">
            <form id="filter-panel" class="filter-panel"></form>
            <div id="devices" class="devices"></div>
        </div>
        <div class="map-panel" id="map-panel">
            <div id="map"></div>
        </div>
        <div class="filter-panel" id="filter-panel-mobile" style="display:none;"></div>
    </div>
    <!-- ... popup ... -->
    <div id="popup-bg" class="popup-bg" style="display:none;">
        <form class="popup" id="settingsForm">
            <h2>Postavke</h2>
            <label for="url">API URL</label>
            <input id="url" name="url" type="text" required placeholder="https://.../TackTest">
            <label for="pin">PIN</label>
            <input id="pin" name="pin" type="password" required placeholder="PIN">
            <div style="display:flex;gap:1em;justify-content:flex-end;">
                <button type="button" id="cancelSettingsBtn">Odustani</button>
                <button type="submit">Spremi</button>
            </div>
        </form>
    </div>
    <script>
        // --- FILTERS LOGIC ---
        const filterDefaults = {
            battery: "",
            health: "",
            temp: "",
            charger: "",
            display: "",
            duplicateIp: false,
            distance: "",
            update: ""
        };
        function getFilters() {
            try {
                return JSON.parse(localStorage.getItem("filters") || "{}");
            } catch { return {}; }
        }
        function setFilters(filters) {
            localStorage.setItem("filters", JSON.stringify(filters));
        }
        function renderFilterPanel(panelId) {
            const filters = { ...filterDefaults, ...getFilters() };
            const batteryOpts = ["", "<95", "<90", "<85", "<80", "<75", "<70", "<65", "<60", "<55", "<50"];
            const healthOpts = [
                "", "GOOD", "NOTGOOD", "NONE", "UNKNOWN"
            ];
            const tempOpts = ["", ">30", ">35", ">38", ">39", ">40", ">41", ">42", ">45"];
            const chargerOpts = ["", "AC", "NOTAC", "NONE", "UNKNOWN"];
            const displayOpts = ["", "ON", "OFF"];
            const distanceOpts = ["", ">3", ">5", ">7", ">10", ">12", ">15", ">20", ">25", ">30", ">40", ">50", ">70", ">80", ">100", ">500", ">1000"];
            const updateOpts = ["", ">5", ">10", ">15", ">17", ">18", ">19", ">25", ">30", ">35", ">40", ">55"];
            const panel = document.getElementById(panelId);
            panel.innerHTML = `
                        <div class="filter-item">
                            <label for="filter-battery">Baterija:</label>
                            <select id="filter-battery">${batteryOpts.map(o => `<option value="${o}"${filters.battery === o ? " selected" : ""}>${o || "Sve"}</option>`).join("")}</select>
                        </div>
                        <div class="filter-item">
                            <label for="filter-health">Zdravlje:</label>
                            <select id="filter-health">
                                <option value="">Sve</option>
                                <option value="GOOD"${filters.health === "GOOD" ? " selected" : ""}>GOOD</option>
                                <option value="NOTGOOD"${filters.health === "NOTGOOD" ? " selected" : ""}>NOT GOOD</option>
                                <option value="NONE"${filters.health === "NONE" ? " selected" : ""}>NONE</option>
                                <option value="UNKNOWN"${filters.health === "UNKNOWN" ? " selected" : ""}>UNKNOWN</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label for="filter-temp">Temp:</label>
                            <select id="filter-temp">${tempOpts.map(o => `<option value="${o}"${filters.temp === o ? " selected" : ""}>${o || "Sve"}</option>`).join("")}</select>
                        </div>
                        <div class="filter-item">
                            <label for="filter-charger">Punjač:</label>
                            <select id="filter-charger">
                                <option value="">Sve</option>
                                <option value="AC"${filters.charger === "AC" ? " selected" : ""}>AC</option>
                                <option value="NOTAC"${filters.charger === "NOTAC" ? " selected" : ""}>NOT AC</option>
                                <option value="NONE"${filters.charger === "NONE" ? " selected" : ""}>NONE</option>
                                <option value="UNKNOWN"${filters.charger === "UNKNOWN" ? " selected" : ""}>UNKNOWN</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label for="filter-display">Display:</label>
                            <select id="filter-display">
                                <option value="">Sve</option>
                                <option value="ON"${filters.display === "ON" ? " selected" : ""}>ON</option>
                                <option value="OFF"${filters.display === "OFF" ? " selected" : ""}>OFF</option>
                            </select>
                        </div>
                        <div class="filter-item filter-checkbox">
                            <input type="checkbox" id="filter-duplicateIp" ${filters.duplicateIp ? "checked" : ""}>
                            <label for="filter-duplicateIp">Duplicate IP</label>
                        </div>
                        <div class="filter-item">
                            <label for="filter-distance">Udaljenost:</label>
                            <select id="filter-distance">${distanceOpts.map(o => `<option value="${o}"${filters.distance === o ? " selected" : ""}>${o || "Sve"}</option>`).join("")}</select>
                        </div>
                        <div class="filter-item">
                            <label for="filter-update">Ažuriranje:</label>
                            <select id="filter-update">${updateOpts.map(o => `<option value="${o}"${filters.update === o ? " selected" : ""}>${o || "Sve"}</option>`).join("")}</select>
                        </div>
                    `;
            // Event listeners
            panel.querySelectorAll("select, input[type=checkbox]").forEach(el => {
                el.onchange = () => {
                    const newFilters = {
                        battery: panel.querySelector("#filter-battery").value,
                        health: panel.querySelector("#filter-health").value,
                        temp: panel.querySelector("#filter-temp").value,
                        charger: panel.querySelector("#filter-charger").value,
                        display: panel.querySelector("#filter-display").value,
                        duplicateIp: panel.querySelector("#filter-duplicateIp").checked,
                        distance: panel.querySelector("#filter-distance").value,
                        update: panel.querySelector("#filter-update").value
                    };
                    setFilters(newFilters);
                    applyFiltersAndRender();
                };
            });
        }
        // --- FILTERING LOGIC ---
        function applyFiltersAndRender() {
            let devices = window.allDevices || [];
            const filters = { ...filterDefaults, ...getFilters() };
            // Duplicate IPs
            let duplicateIps = {};
            if (filters.duplicateIp) {
                const ipCount = {};
                devices.forEach(d => {
                    const ip = d.properties?.ip;
                    if (ip) ipCount[ip] = (ipCount[ip] || 0) + 1;
                });
                duplicateIps = Object.fromEntries(Object.entries(ipCount).filter(([k, v]) => v > 1));
            }
            // Filter
            let filtered = devices.filter(d => {
                const p = d.properties || {};
                // Baterija
                if (filters.battery) {
                    const val = parseInt(p.Level || 0);
                    const num = parseInt(filters.battery.replace("<", ""));
                    if (!(val < num)) return false;
                }
                // Zdravlje (Ažurirana logika: NOT GOOD znači != 'GOOD')
                if (filters.health) {
                    if (filters.health === "GOOD" && p.Health !== "GOOD") return false;
                    if (filters.health === "NOTGOOD" && p.Health === "GOOD") return false; /* Ažurirano */
                    if (filters.health === "NONE" && p.Health !== "NONE") return false;
                    if (filters.health === "UNKNOWN" && p.Health !== "UNKNOWN") return false;
                }
                // Temp
                if (filters.temp) {
                    const val = parseFloat(p.Temperature || 0);
                    const num = parseInt(filters.temp.replace(">", ""));
                    if (!(val > num)) return false;
                }
                // Punjač (Ažurirana logika: NOT AC znači != 'AC')
                if (filters.charger) {
                    if (filters.charger === "AC" && p.Plugged !== "AC") return false;
                    if (filters.charger === "NOTAC" && p.Plugged === "AC") return false; /* Ažurirano */
                    if (filters.charger === "NONE" && p.Plugged !== "NONE") return false;
                    if (filters.charger === "UNKNOWN" && p.Plugged !== "UNKNOWN") return false;
                }
                // Display
                if (filters.display) {
                    if (filters.display === "ON" && p.display !== "1") return false;
                    if (filters.display === "OFF" && p.display === "1") return false;
                }
                // Duplicate IP
                if (filters.duplicateIp) {
                    if (!p.ip || !duplicateIps[p.ip]) return false;
                }
                // Udaljenost
                if (filters.distance) {
                    const startLat = parseFloat(p.startLat || 0);
                    const startLon = parseFloat(p.startLon || 0);
                    const currentLat = parseFloat(p.currentLat || 0);
                    const currentLon = parseFloat(p.currentLon || 0);
                    if (startLat && startLon && currentLat && currentLon) {
                        const dist = getDistanceInMeters(startLat, startLon, currentLat, currentLon);
                        const num = parseInt(filters.distance.replace(">", ""));
                        if (!(dist > num)) return false;
                    } else {
                        return false;
                    }
                }
                // Ažuriranje
                if (filters.update) {
                    if (!p.lastUpdate) return false;
                    const t = new Date(p.lastUpdate);
                    const now = new Date();
                    const agoMin = Math.floor((now - t) / 60000);
                    const num = parseInt(filters.update.replace(">", ""));
                    if (!(agoMin > num)) return false;
                }
                return true;
            });
            window.devicesData = filtered;
            renderDevices(filtered);
            renderMap(filtered, selectedDeviceIndex);
        }
        // --- PATCH TABS FOR FILTER ---
        function patchTabsForFilter() {
            // Desktop: filter je uvijek prikazan
            // Mobile: filter je prvi tab, lista drugi, karta treći
            function showTab(tab) {
                const isMobile = window.innerWidth <= 600;
                const devicesPanel = document.getElementById('devices-panel');
                const mapPanel = document.getElementById('map-panel');
                const tabs = document.getElementById('tabs');
                const filterPanel = document.getElementById('filter-panel'); // Desktop filter panel
                const filterPanelMobile = document.getElementById('filter-panel-mobile'); // Mobile filter panel

                if (isMobile) {
                    tabs.style.display = 'flex';
                    if (tab === 'filter') {
                        filterPanelMobile.style.display = ''; // Prikaz mobilnog filtera
                        filterPanel.style.display = 'none'; // Sakrij desktop filter
                        devicesPanel.style.display = 'none'; // Sakrij listu uređaja
                        mapPanel.style.display = 'none'; // Sakrij kartu
                        document.getElementById('tab-filter').classList.add('active');
                        document.getElementById('tab-lista').classList.remove('active');
                        document.getElementById('tab-karta').classList.remove('active');
                    } else if (tab === 'lista') {
                        filterPanelMobile.style.display = 'none'; // Sakrij mobilni filter
                        filterPanel.style.display = 'none'; // **KLJUČNA IZMJENA: Sakrij desktop filter**
                        devicesPanel.style.display = ''; // Prikaz liste uređaja
                        mapPanel.style.display = 'none'; // Sakrij kartu
                        document.getElementById('tab-filter').classList.remove('active');
                        document.getElementById('tab-lista').classList.add('active');
                        document.getElementById('tab-karta').classList.remove('active');
                        // Re-render devices to ensure selection is visible
                        renderDevices(window.devicesData);
                    } else { // tab === 'karta'
                        filterPanelMobile.style.display = 'none'; // Sakrij mobilni filter
                        filterPanel.style.display = 'none'; // **KLJUČNA IZMJENA: Sakrij desktop filter**
                        devicesPanel.style.display = 'none'; // Sakrij listu uređaja
                        mapPanel.style.display = ''; // Prikaz karte
                        document.getElementById('tab-filter').classList.remove('active');
                        document.getElementById('tab-lista').classList.remove('active');
                        document.getElementById('tab-karta').classList.add('active');
                        // Re-render map to ensure selection is visible
                        renderMap(window.devicesData, selectedDeviceIndex);
                        // Also, if a device is selected, open its info window
                        if (selectedDeviceIndex !== null && window.devicesData[selectedDeviceIndex]) {
                            const p = window.devicesData[selectedDeviceIndex].properties || {};
                            let locType = "start";
                            if (p.currentLat && p.currentLon && p.startLat && p.startLon) {
                                const dist = getDistanceInMeters(
                                    parseFloat(p.startLat), parseFloat(p.startLon),
                                    parseFloat(p.currentLat), parseFloat(p.currentLon)
                                );
                                if (dist > 7) locType = "current";
                            }
                            openInfoWindowForDevice(selectedDeviceIndex, locType);
                        }
                    }
                } else { // Desktop prikaz
                    tabs.style.display = 'none';
                    filterPanel.style.display = 'grid';
                    devicesPanel.style.display = 'flex';
                    mapPanel.style.display = 'flex';
                }
            }
            window.showTab = showTab;
            document.getElementById('tab-filter').onclick = () => showTab('filter');
            document.getElementById('tab-lista').onclick = () => showTab('lista');
            document.getElementById('tab-karta').onclick = () => showTab('karta');
            window.addEventListener('resize', () => {
                showTab(window.innerWidth <= 600
                    ? (document.getElementById('tab-filter').classList.contains('active') ? 'filter'
                        : document.getElementById('tab-lista').classList.contains('active') ? 'lista' : 'karta')
                    : 'both');
            });
        }


    </script>
    <script>
        // Global variable to hold the status icon element
        let statusIconElement;

        // Function to update the status icon
        function updateStatusIcon(status) {
            if (!statusIconElement) {
                statusIconElement = document.getElementById('statusIcon');
            }
            if (!statusIconElement) return;

            statusIconElement.style.display = 'flex'; // Always show when updating status
            statusIconElement.className = 'status-icon'; // Reset classes

            switch (status) {
                case 'loading':
                    statusIconElement.classList.add('status-loading');
                    statusIconElement.innerHTML = '<i class="fa-solid fa-arrows-rotate"></i>';
                    break;
                case 'success':
                    statusIconElement.classList.add('status-success');
                    statusIconElement.innerHTML = '<i class="fa-solid fa-check"></i>';
                    //setTimeout(() => {
                    //    statusIconElement.style.display = 'none'; // Hide after a short delay
                    //}, 2000); // 2 seconds
                    break;
                case 'error':
                    statusIconElement.classList.add('status-error');
                    statusIconElement.innerHTML = '<i class="fa-solid fa-xmark"></i>';
                    //setTimeout(() => {
                    //    statusIconElement.style.display = 'none'; // Hide after a short delay
                    //}, 2000); // 2 seconds
                    break;
                default:
                    statusIconElement.style.display = 'none'; // Hide by default or unknown status
                    break;
            }
        }

        function deselectDevice() {
            selectedDeviceIndex = null;
            // Ukloni selekciju s liste
            document.querySelectorAll('.device-card').forEach(el => el.classList.remove('selected'));
            // Zatvori infoWindow na karti (ako postoji)
            if (window.map && window.infoWindow) {
                window.infoWindow.close();
            }
        }

        // Dodaj globalni infoWindow za mapu
        let infoWindow = null;
        // Helpers
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            function toRad(x) { return x * Math.PI / 180; }
            var R = 6371;
            var dLat = toRad(lat2 - lat1);
            var dLon = toRad(lon2 - lon1);
            var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }
        function timeAgo(iso) {
            if (!iso) return '';
            const t = new Date(iso);
            const now = new Date();
            const diff = Math.floor((now - t) / 60000);
            if (diff < 1) return 'prije par sekundi';
            if (diff === 1) return 'prije minutu';
            if (diff < 60) return `prije ${diff} min`;
            const h = Math.floor(diff / 60);
            if (h === 1) return 'prije sat';
            if (h < 5) return `prije ${h} sata`;
            if (h < 24) return `prije ${h} sati`;
            const d = Math.floor(h / 24);
            if (d === 1) return 'jučer';
            return `prije ${d} dana`;
        }
        function batteryColor(level) {
            if (level >= 80) return 'var(--success)';
            if (level >= 40) return 'var(--warning)';
            return 'var(--danger)';
        }
        function tempColor(temp) {
            if (temp < 10) return 'var(--primary)';
            if (temp < 35) return 'var(--success)';
            if (temp < 45) return 'var(--warning)';
            return 'var(--danger)';
        }
        function healthColor(health) {
            if (!health) return 'var(--muted)';
            if (health === 'GOOD') return 'var(--success)';
            if (health === 'OVERHEAT' || health === 'DEAD' || health === 'UNSPECIFIED_FAILURE') return 'var(--danger)';
            return 'var(--warning)';
        }
        function pluggedIcon(plugged) {
            if (plugged === 'AC') return '<i class="fa-solid fa-plug" style="color:var(--primary)" title="AC"></i>';
            if (plugged === 'USB') return '<i class="fa-solid fa-usb" style="color:var(--primary)" title="USB"></i>';
            if (plugged === 'WIRELESS') return '<i class="fa-solid fa-bolt" style="color:var(--primary)" title="Wireless"></i>';
            return '<i class="fa-regular fa-circle" style="color:var(--muted)" title="Nije priključeno"></i>';
        }
        // Promijenjeno u fa-desktop
        function displayIcon(on) {
            return on == "1"
                ? '<i class="fa-solid fa-desktop" style="color:var(--success)" title="Display ON"></i>'
                : '<i class="fa-solid fa-desktop" style="color:var(--muted)" title="Display OFF"></i>';
        }
        function getLocationIcon() {
            return '<i class="fa-solid fa-location-dot" style="color:var(--primary)"></i>';
        }
        function wifiIcon() {
            return '<i class="fa-solid fa-wifi" style="color:var(--primary)"></i>';
        }
        function thermometerIcon() {
            return '<i class="fa-solid fa-thermometer-half"></i>';
        }
        function heartIcon() {
            return '<i class="fa-solid fa-heart-pulse"></i>';
        }
        // Popup logic
        function fillSettingsForm() {
            const { url, pin } = getSettings();
            document.getElementById('url').value = url;
            document.getElementById('pin').value = pin;
        }
        function showPopup() {
            fillSettingsForm();
            document.getElementById('popup-bg').style.display = 'flex';
        }
        function hidePopup() {
            document.getElementById('popup-bg').style.display = 'none';
        }
        // Settings
        function getSettings() {
            return {
                url: localStorage.getItem('url') || '',
                pin: localStorage.getItem('pin') || ''
            };
        }
        function setSettings(url, pin) {
            localStorage.setItem('url', url);
            localStorage.setItem('pin', pin);
        }
        // Fetch devices
        async function fetchDevices() {
            const { url, pin } = getSettings();
            try {
                const res = await fetch(`${url}/listFiles?pin=${encodeURIComponent(pin)}`);
                if (!res.ok) throw new Error('Greška kod API poziva');
                return await res.json();
            } catch (e) {
                throw e; // Re-throw the error so loadAll can catch it
            }
        }
        // Fetch map key
        async function fetchMapKey() {
            const { url, pin } = getSettings();
            try {
                const res = await fetch(`${url}/mapKey?pin=${encodeURIComponent(pin)}`);
                if (!res.ok) throw new Error('Greška kod API poziva');
                const data = await res.json();
                return data.key || '';
            } catch (e) {
                throw e; // Re-throw the error so loadAll can catch it
            }
        }
        // Google Maps
        let map, markers = [], polylines = [], selectedDeviceIndex = null, mapApiLoaded = false, mapKey = '';

        function clearMarkers() {
            markers.forEach(m => m.setMap(null));
            markers = [];
        }
        function clearPolylines() {
            polylines.forEach(line => line.setMap(null));
            polylines = [];
        }
        function selectDeviceOnMap(idx) {
            if (typeof idx !== "number" || !window.devicesData || !window.devicesData[idx]) return;
            const dev = window.devicesData[idx];
            const p = dev.properties || {};
            let lat = parseFloat(p.currentLat || p.startLat || 0);
            let lon = parseFloat(p.currentLon || p.startLon || 0);
            if (lat && lon && map) {
                map.panTo({ lat, lng: lon });
                map.setZoom(15);
            }
        }
        function getDistanceInMeters(lat1, lon1, lat2, lon2) {
            function toRad(x) { return x * Math.PI / 180; }
            var R = 6371000;
            var dLat = toRad(lat2 - lat1);
            var dLon = toRad(lon2 - lon1);
            var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }
        function batteryIcon(level) {
            let color = batteryColor(level);
            return `<i class="fa-solid fa-battery-full" style="color:${color}" title="Baterija"></i>`;
        }
        function tempIcon(temp) {
            let color = tempColor(temp);
            return `<i class="fa-solid fa-thermometer-half" style="color:${color}" title="Temperatura"></i>`;
        }
        function healthIcon(health) {
            let color = healthColor(health);
            return `<i class="fa-solid fa-heart-pulse" style="color:${color}" title="Zdravlje"></i>`;
        }
        function pluggedMiniIcon(plugged) {
            if (plugged === 'AC') return '<i class="fa-solid fa-plug" style="color:#1976d2" title="AC"></i>';
            if (plugged === 'USB') return '<i class="fa-solid fa-usb" style="color:#1976d2" title="USB"></i>';
            if (plugged === 'WIRELESS') return '<i class="fa-solid fa-bolt" style="color:#1976d2" title="Wireless"></i>';
            return '<i class="fa-regular fa-circle" style="color:#bdbdbd" title="Nije priključeno"></i>';
        }
        // Promijenjeno u fa-desktop
        function displayMiniIcon(on) {
            return on == "1"
                ? '<i class="fa-solid fa-desktop" style="color:#43a047" title="Display ON"></i>'
                : '<i class="fa-solid fa-desktop" style="color:#bdbdbd" title="Display OFF"></i>';
        }
        function wifiMiniIcon() {
            return '<i class="fa-solid fa-wifi" style="color:#1976d2" title="IP"></i>';
        }

        function deviceDetailsHtml(dev, p) {
            // Izračun udaljenosti i vremena ažuriranja
            let dist = 0, distRed = false, agoMin = 0, agoRed = false;
            if (p.startLat && p.startLon && p.currentLat && p.currentLon) {
                dist = getDistanceInMeters(
                    parseFloat(p.startLat), parseFloat(p.startLon),
                    parseFloat(p.currentLat), parseFloat(p.currentLon)
                );
                distRed = dist > 7;
            }
            if (p.lastUpdate) {
                const t = new Date(p.lastUpdate);
                const now = new Date();
                agoMin = Math.floor((now - t) / 60000);
                agoRed = agoMin > 20;
            }

            return `
                    <div class="info-window-details">
                        <div class="header">
                            <i class="fa-solid fa-microchip"></i> ${dev.name || 'Nepoznato ime'}
                        </div>
                        <div class="prop-grid">
                            <div class="label-icon">${batteryIcon(p.Level ?? 0)} Baterija:</div><div class="value">${isNaN(p.Level) ? '?' : (p.Level ?? '?') + '%'}</div>
                            <div class="label-icon">${healthIcon(p.Health)} Zdravlje:</div><div class="value">${p.Health ?? '?'}</div>
                            <div class="label-icon">${tempIcon(p.Temperature ?? 0)} Temp:</div><div class="value">${isNaN(p.Temperature) ? '?' : (p.Temperature ?? '?') + '°C'}</div>
                            <div class="label-icon">${pluggedMiniIcon(p.Plugged)} Punjač:</div><div class="value">${p.Plugged ?? '?'}</div>
                            <div class="label-icon">${displayMiniIcon(p.display)} Display:</div><div class="value">${p.display == "1" ? "DA" : "NE"}</div>
                            <div class="label-icon">${wifiMiniIcon()} IP:</div><div class="value">${p.ip ?? '?'}</div>
                        </div>
                        <div class="location-info ${distRed ? 'red' : ''}">
                            <i class="fa-solid fa-location-dot"></i>
                            <b>Start:</b> ${p.startLat && p.startLon ? `${p.startLat}, ${p.startLon}` : 'N/A'}
                        </div>
                        <div class="location-info ${distRed ? 'red' : ''}">
                            <i class="fa-solid fa-location-dot"></i>
                            <b>Trenutno:</b> ${p.currentLat && p.currentLon ? `${p.currentLat}, ${p.currentLon}` : 'N/A'}
                            ${dist ? `<span style="font-size:0.95em;">(${dist.toFixed(1)} m)</span>` : ''}
                        </div>
                        <div class="last-update-info ${agoRed ? 'red' : ''}">
                            <i class="fa-regular fa-clock"></i>
                            <b>Ažurirano:</b> ${p.lastUpdate ? timeAgo(p.lastUpdate) : 'N/A'}
                        </div>
                    </div>
                    `;
        }


        function renderMap(devices, selectIdx) {
            if (!mapApiLoaded) return;
            clearMarkers();
            clearPolylines();
            if (!devices || !devices.length) return;
            let bounds = new google.maps.LatLngBounds();
            if (!infoWindow) infoWindow = new google.maps.InfoWindow();

            devices.forEach((dev, idx) => {
                const p = dev.properties || {};
                const hasStart = p.startLat && p.startLon;
                const hasCurrent = p.currentLat && p.currentLon;
                let showCurrent = false;
                let distMeters = 0;
                if (hasStart && hasCurrent) {
                    distMeters = getDistanceInMeters(
                        parseFloat(p.startLat), parseFloat(p.startLon),
                        parseFloat(p.currentLat), parseFloat(p.currentLon)
                    );
                    showCurrent = distMeters > 7;
                }
                // Start location marker (zeleni krug)
                if (hasStart) {
                    const marker = new google.maps.Marker({
                        position: { lat: parseFloat(p.startLat), lng: parseFloat(p.startLon) },
                        map,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 10,
                            fillColor: "#43a047",
                            fillOpacity: 1,
                            strokeWeight: 2,
                            strokeColor: "#2e7031"
                        },
                        title: `${dev.name} (Start)`,
                        zIndex: 1
                    });
                    marker.addListener('click', function (e) {
                        if (selectedDeviceIndex === idx && window.infoWindow && window.infoWindow.getMap()) {
                            deselectDevice();
                        } else {
                            infoWindow.setContent(deviceDetailsHtml(dev, p));
                            infoWindow.open(map, marker);
                            selectDevice(idx, "start");
                        }
                        if (e && e.stopPropagation) e.stopPropagation();
                    });
                    markers.push(marker);
                    bounds.extend(marker.getPosition());
                }
                // Current location marker (crveni krug, samo ako je >7m)
                if (hasCurrent && showCurrent) {
                    const marker = new google.maps.Marker({
                        position: { lat: parseFloat(p.currentLat), lng: parseFloat(p.currentLon) },
                        map,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 12,
                            fillColor: "#e53935",
                            fillOpacity: 1,
                            strokeWeight: 3,
                            strokeColor: "#b71c1c"
                        },
                        title: `${dev.name} (Trenutno)`,
                        zIndex: 2
                    });
                    marker.addListener('click', function (e) {
                        if (selectedDeviceIndex === idx && window.infoWindow && window.infoWindow.getMap()) {
                            deselectDevice();
                        } else {
                            infoWindow.setContent(deviceDetailsHtml(dev, p));
                            infoWindow.open(map, marker);
                            selectDevice(idx, "current");
                        }
                        if (e && e.stopPropagation) e.stopPropagation();
                    });
                    markers.push(marker);
                    bounds.extend(marker.getPosition());
                }
                // Polyline između start i current (uvijek ako oba postoje)
                if (hasStart && hasCurrent) {
                    const line = new google.maps.Polyline({
                        path: [
                            { lat: parseFloat(p.startLat), lng: parseFloat(p.startLon) },
                            { lat: parseFloat(p.currentLat), lng: parseFloat(p.currentLon) }
                        ],
                        geodesic: true,
                        strokeColor: "#e53935",
                        strokeOpacity: 1,
                        strokeWeight: 2,
                        map: map
                    });
                    polylines.push(line);
                }
            });
            if (!bounds.isEmpty()) {
                map.fitBounds(bounds);
            }
            // Ensure selected device is highlighted and info window is open if map is rendered
            if (typeof selectIdx === "number" && devices[selectIdx]) {
                selectDeviceOnMap(selectIdx);
                // Re-open info window if it was closed or not opened yet
                const p = devices[selectIdx].properties || {};
                let locType = "start";
                if (p.currentLat && p.currentLon && p.startLat && p.startLon) {
                    const dist = getDistanceInMeters(
                        parseFloat(p.startLat), parseFloat(p.startLon),
                        parseFloat(p.currentLat), parseFloat(p.currentLon)
                    );
                    if (dist > 7) locType = "current";
                }
                openInfoWindowForDevice(selectIdx, locType);
            }


            // Klik na prazno područje karte deselektira
            google.maps.event.clearListeners(map, 'click');
            map.addListener('click', function () {
                deselectDevice();
                if (infoWindow) infoWindow.close();
            });
            // Spremi infoWindow globalno
            window.infoWindow = infoWindow;
        }

        function openInfoWindowForDevice(idx, locType) {
            if (!markers || !window.devicesData || !window.infoWindow) return;
            const dev = window.devicesData[idx];
            if (!dev) return;
            const p = dev.properties || {};
            // Pronađi marker: locType = "start" ili "current"
            let marker = null;
            if (locType === "current" && p.currentLat && p.currentLon) { // Provjeri postojanje koordinata
                marker = markers.find(m =>
                    m.getPosition().lat() === parseFloat(p.currentLat) &&
                    m.getPosition().lng() === parseFloat(p.currentLon)
                );
            } else if (p.startLat && p.startLon) { // Provjeri postojanje koordinata
                marker = markers.find(m =>
                    m.getPosition().lat() === parseFloat(p.startLat) &&
                    m.getPosition().lng() === parseFloat(p.startLon)
                );
            }
            if (marker) {
                window.infoWindow.setContent(deviceDetailsHtml(dev, p));
                window.infoWindow.open(map, marker);
            }
        }

        //// Klik izvan kartice u listi deselektira
        //document.addEventListener('click', function (e) {
        //    // Ako klik nije na .device-card, deselektiraj (ali ignoriraj klikove na mapu i info prozor)
        //    if (
        //        !e.target.closest('.device-card') &&
        //        !e.target.closest('#map') &&
        //        !e.target.closest('.gm-style-iw')
        //    ) {
        //        deselectDevice();
        //    }
        //});

        // Dodaj "Odustani" na postavke
        document.getElementById('cancelSettingsBtn').onclick = function (e) {
            e.preventDefault();
            hidePopup();
        };
        // Select device in list and on map
        function selectDevice(idx, locType) {
            selectedDeviceIndex = idx;
            // Highlight card
            document.querySelectorAll('.device-card').forEach((el, i) => {
                el.classList.toggle('selected', i === idx);
            });
            // Center map
            if (window.devicesData && window.devicesData[idx]) {
                const p = window.devicesData[idx].properties || {};
                let lat = 0, lon = 0;
                if (locType === "current" && p.currentLat && p.currentLon) {
                    lat = parseFloat(p.currentLat);
                    lon = parseFloat(p.currentLon);
                } else if (p.startLat && p.startLon) {
                    lat = parseFloat(p.startLat);
                    lon = parseFloat(p.startLon);
                }
                if (lat && lon && map) {
                    map.panTo({ lat, lng: lon });
                    map.setZoom(15);
                }
            }
        }

        // Render devices
        function renderDevices(devices) {
            window.devicesData = devices;
            const container = document.getElementById('devices');
            container.innerHTML = '';
            if (!devices || !devices.length) {
                container.innerHTML = '<div style="text-align:center;color:var(--muted);font-size:1.2em;">Nema uređaja.</div>';
                return;
            }
            devices.forEach((dev, idx) => {
                const p = dev.properties || {};
                // Baterija
                const level = parseInt(p.Level || 0);
                const temp = parseFloat(p.Temperature || 0);
                const health = p.Health || '';
                const plugged = p.Plugged || '';
                const display = p.display || '0';
                // Lokacije
                const startLat = parseFloat(p.startLat || 0);
                const startLon = parseFloat(p.startLon || 0);
                const currentLat = parseFloat(p.currentLat || 0);
                const currentLon = parseFloat(p.currentLon || 0);
                let distance = '';
                if (startLat && startLon && currentLat && currentLon) {
                    const d = getDistanceFromLatLonInKm(startLat, startLon, currentLat, currentLon);
                    distance = `<span class="distance">(${d.toFixed(2)} km)</span>`;
                }
                // Last update
                const lastUpdate = p.lastUpdate ? timeAgo(p.lastUpdate) : '';
                // Card
                const card = document.createElement('div');
                card.className = 'device-card' + (selectedDeviceIndex === idx ? ' selected' : '');
                card.innerHTML = `
                                            <div class="device-header">
                        <i class="fa-solid fa-microchip"></i>
                        <span>${dev.name || 'Nepoznato ime'}</span>
                    </div>
                    <div class="device-props" style="display:grid;grid-template-columns:1fr 1fr;gap:0.2em 0.7em;">
                        <div class="prop">${batteryIcon(level)}<span>Baterija</span><span>${isNaN(level) ? '?' : level + '%'}</span></div>
                        <div class="prop">${healthIcon(health)}<span>Zdravlje</span><span>${health || '?'}</span></div>
                        <div class="prop">${tempIcon(temp)}<span>Temp</span><span>${isNaN(temp) ? '?' : temp.toFixed(1) + '°C'}</span></div>
                        <div class="prop">${pluggedMiniIcon(plugged)}<span>Punjač</span><span>${plugged || '?'}</span></div>
                        <div class="prop">${displayMiniIcon(display)}<span>Display</span><span>${display == "1" ? "DA" : "NE"}</span></div>
                        <div class="prop">${wifiMiniIcon()}<span>IP</span><span>${p.ip || '?'}</span></div>
                    </div>
                    <div class="prop" style="margin-top:4px;${(startLat && startLon && currentLat && currentLon && getDistanceInMeters(startLat, startLon, currentLat, currentLon) > 7) ? 'color:#e53935;font-weight:600' : ''}">
                        <i class="fa-solid fa-location-dot" ${(startLat && startLon && currentLat && currentLon && getDistanceInMeters(startLat, startLon, currentLat, currentLon) > 7) ? 'style="color:#e53935"' : ''}></i>
                        <span>Start</span>
                        <span>${p.startLat && p.startLon ? `${p.startLat}, ${p.startLon}` : 'N/A'}</span>
                    </div>
                    <div class="prop" style="margin-top:2px;${(startLat && startLon && currentLat && currentLon && getDistanceInMeters(startLat, startLon, currentLat, currentLon) > 7) ? 'color:#e53935;font-weight:600' : ''}">
                        <i class="fa-solid fa-location-dot" ${(startLat && startLon && currentLat && currentLon && getDistanceInMeters(startLat, startLon, currentLat, currentLon) > 7) ? 'style="color:#e53935"' : ''}></i>
                        <span>Trenutno</span>
                        <span>${p.currentLat && p.currentLon ? `${p.currentLat}, ${p.currentLon}` : 'N/A'}</span>
                        ${distance}
                    </div>
                    <div class="last-update" style="${(p.lastUpdate && ((new Date() - new Date(p.lastUpdate)) / 60000) > 20) ? 'color:#e53935;font-weight:600' : ''}">
                        <i class="fa-regular fa-clock" ${(p.lastUpdate && ((new Date() - new Date(p.lastUpdate)) / 60000) > 20) ? 'style="color:#e53935"' : ''}></i>
                        <span>${lastUpdate ? 'Ažurirano ' + lastUpdate : 'Nema podataka'}</span>
                    </div>
`;
                card.onclick = () => {
                    if (selectedDeviceIndex === idx) { // Ako je već odabran, deselektiraj
                        deselectDevice();
                    } else { // Inače, odaberi ovaj uređaj
                        selectDevice(idx);
                        // Prikaži info prozor na markeru (preferiraj current, ako postoji i prikazuje se)
                        const p = dev.properties || {};
                        let locType = "start";
                        if (p.currentLat && p.currentLon && p.startLat && p.startLon) {
                            const dist = getDistanceInMeters(
                                parseFloat(p.startLat), parseFloat(p.startLon),
                                parseFloat(p.currentLat), parseFloat(p.currentLon)
                            );
                            if (dist > 7) locType = "current";
                        }
                        openInfoWindowForDevice(idx, locType);
                    }
                };
                container.appendChild(card);
            });
        }
        // On load
        // --- PATCHED ONLOAD ---
        window.addEventListener('DOMContentLoaded', async () => {
            statusIconElement = document.getElementById('statusIcon'); // Initialize on DOMContentLoaded
            updateStatusIcon('none'); // Ensure it's hidden initially

            renderFilterPanel('filter-panel');
            renderFilterPanel('filter-panel-mobile');
            patchTabsForFilter();
            const settings = getSettings();
            if (!settings.url || !settings.pin) {
                showPopup();
            } else {
                await loadAll();
            }
            // Popup submit
            document.getElementById('settingsForm').onsubmit = async e => {
                e.preventDefault();
                const url = document.getElementById('url').value.trim();
                const pin = document.getElementById('pin').value.trim();
                if (!url || !pin) return;
                setSettings(url, pin);
                hidePopup();
                await loadAll();
            };
            // Postavi zadani tab na "Lista" za mobilne uređaje pri učitavanju
            showTab(window.innerWidth <= 600 ? 'lista' : 'both');
        });
        // --- PATCHED LOADALL ---
        async function loadAll() {
            updateStatusIcon('loading'); // Set to loading state
            //renderDevices([{ name: "Učitavam...", properties: {} }]);
            try {
                const [devices, key] = await Promise.all([fetchDevices(), fetchMapKey()]);
                window.allDevices = devices;
                mapKey = key;
                applyFiltersAndRender();
                if (!mapApiLoaded && key) {
                    loadGoogleMapsApi(key);
                } else if (mapApiLoaded) {
                    renderMap(window.devicesData, selectedDeviceIndex);
                }
                updateStatusIcon('success'); // Set to success state
            } catch (error) {
                console.error("Failed to load data:", error);
                updateStatusIcon('error'); // Set to error state
                // Optionally, display a more user-friendly error message
                renderDevices([{ name: "Greška pri učitavanju podataka.", properties: {} }]);
            }
        }
        // Google Maps API loader
        function loadGoogleMapsApi(key) {
            if (window.google && window.google.maps) {
                mapApiLoaded = true;
                initMap();
                return;
            }
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${key}&callback=initMap&language=hr`;
            script.async = true;
            window.initMap = function () {
                mapApiLoaded = true;
                map = new google.maps.Map(document.getElementById('map'), {
                    center: { lat: 45.8, lng: 16.0 },
                    zoom: 8,
                    mapTypeControl: false,
                    streetViewControl: false
                });
                renderMap(window.devicesData || [], selectedDeviceIndex);
            };
            document.body.appendChild(script);
        }
        // Tabs logic
        function showTab(tab) {
            const isMobile = window.innerWidth <= 600;
            const devicesPanel = document.getElementById('devices-panel');
            const mapPanel = document.getElementById('map-panel');
            const tabs = document.getElementById('tabs');
            const filterPanel = document.getElementById('filter-panel'); // Desktop filter panel
            const filterPanelMobile = document.getElementById('filter-panel-mobile'); // Mobile filter panel

            if (isMobile) {
                tabs.style.display = 'flex';
                if (tab === 'filter') {
                    filterPanelMobile.style.display = ''; // Prikaz mobilnog filtera
                    filterPanel.style.display = 'none'; // Sakrij desktop filter
                    devicesPanel.style.display = 'none'; // Sakrij listu uređaja
                    mapPanel.style.display = 'none'; // Sakrij kartu
                    document.getElementById('tab-filter').classList.add('active');
                    document.getElementById('tab-lista').classList.remove('active');
                    document.getElementById('tab-karta').classList.remove('active');
                } else if (tab === 'lista') {
                    filterPanelMobile.style.display = 'none'; // Sakrij mobilni filter
                    filterPanel.style.display = 'none'; // **KLJUČNA IZMJENA: Sakrij desktop filter**
                    devicesPanel.style.display = ''; // Prikaz liste uređaja
                    mapPanel.style.display = 'none'; // Sakrij kartu
                    document.getElementById('tab-filter').classList.remove('active');
                    document.getElementById('tab-lista').classList.add('active');
                    document.getElementById('tab-karta').classList.remove('active');
                    // Re-render devices to ensure selection is visible
                    renderDevices(window.devicesData);
                } else { // tab === 'karta'
                    filterPanelMobile.style.display = 'none'; // Sakrij mobilni filter
                    filterPanel.style.display = 'none'; // **KLJUČNA IZMJENA: Sakrij desktop filter**
                    devicesPanel.style.display = 'none'; // Sakrij listu uređaja
                    mapPanel.style.display = ''; // Prikaz karte
                    document.getElementById('tab-filter').classList.remove('active');
                    document.getElementById('tab-lista').classList.remove('active');
                    document.getElementById('tab-karta').classList.add('active');
                    // Re-render map to ensure selection is visible
                    renderMap(window.devicesData, selectedDeviceIndex);
                    // Also, if a device is selected, open its info window
                    if (selectedDeviceIndex !== null && window.devicesData[selectedDeviceIndex]) {
                        const p = window.devicesData[selectedDeviceIndex].properties || {};
                        let locType = "start";
                        if (p.currentLat && p.currentLon && p.startLat && p.startLon) {
                            const dist = getDistanceInMeters(
                                parseFloat(p.startLat), parseFloat(p.startLon),
                                parseFloat(p.currentLat), parseFloat(p.currentLon)
                            );
                            if (dist > 7) locType = "current";
                        }
                        openInfoWindowForDevice(selectedDeviceIndex, locType);
                    }
                }
            } else { // Desktop prikaz
                tabs.style.display = 'none';
                filterPanel.style.display = 'grid';
                devicesPanel.style.display = 'flex';
                mapPanel.style.display = 'flex';
            }
        }
        window.addEventListener('resize', () => {
            showTab(window.innerWidth <= 600 ? (document.getElementById('tab-filter').classList.contains('active') ? 'filter' : (document.getElementById('tab-lista').classList.contains('active') ? 'lista' : 'karta')) : 'both');
        });
        document.getElementById('settingsBtn').onclick = showPopup;
        document.getElementById('refreshBtn').onclick = loadAll; /* Dodan event listener za osvježavanje */
    </script>
</body>
</html>
